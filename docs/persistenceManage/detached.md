# detached (준영속)


**준영속 상태** : 영속성 컨텍스트가 관리하는 영속 상태의 엔티티가 영속성 컨텍스트에서 분리된 것

<br> 
영속 -> 준영속

### 📌 준영속 상태로 만드는 방법

|||
|--|--|
|`em.detach(entity)`|특정 엔티티만 준영속 상태로 전환|
|`em.clear()`|영속성 컨텍스트 완전히 초기화|
|`em.close()`|영속성 컨텍스트 종료|
|||


### 📌 준영속 상태 특징

✔️ 거의 비영속에 가까움
> 영속성 컨텍스트가 관리하지 않으므로 1차 캐시, 쓰기 지연, 변경 감지, 지연 로딩을 포함한 영속성 컨텍스트가 제공하는 어떠한 기능도 동작하지 않음

<br>

✔️ 식별자 값을 갖고 있음
> 비영속 상태는 식별자 값이 없을수도 있지만 준영속 상태는 이미 한 번 영속 상태였으므로 식별자 값을 갖고 있음 

<br>

✔️ 지연로딩 불가
> 지연 로딩은 실제 객체 대신 프록시 객체를 로딩해두고 해당 객체를 실제 사용할 때 영속성 컨텍스트를 통해 데이터를 불러오는 방법임. 준영속 상태는 영속성 컨텍스트가 더는 관리하지 않으므로 지연 로딩 시 문제가 발생함.

### 📌 병합: merge()

준영속/비영속 상태의 엔티티를 다시 영속 상태로 변환하기 위해 merge() 사용
<br>

#### merge 과정

`em.merge(member);`

1. 준영속 상태인 member 엔티티의 식별자 값으로 1차 캐시에서 엔티티 조회
2. 만약 1차 캐시에 엔티티가 없다면 데이터베이스에서 엔티티 조회 후 1차 캐시에 저장
3. 조회한 영속 엔티티에 member 엔티티 값을 채워 넣음
4. 만약 비영속 상태로 데이터베이스에서도 발견하지 못하면 새로운 엔티티를 생성해 병합함


